#include <ntifs.h>
#include <ntddk.h>
#include <ntimage.h>
#include <windef.h>


#include "util.h"

CHAR * GetProcessNameFromPid(HANDLE pid)
{
	PEPROCESS Process;
	if (PsLookupProcessByProcessId(pid, &Process) == STATUS_INVALID_PARAMETER)
	{
		return "pid???";
	}
	//return L"ASDF";
	return (CHAR*)PsGetProcessImageFileName(Process);
}


BOOL	IsWow64Process(HANDLE	ProcessId)
{
	BOOL	Ret = FALSE;
	HANDLE	hProcess = OpenProcessById(ProcessId, GENERIC_READ);
	PVOID	ProcessWow64Info = NULL;

	if (hProcess)
	{
		NTSTATUS ntStatus = ZwQueryInformationProcess(hProcess, ProcessWow64Information, &ProcessWow64Info, sizeof(PVOID), NULL);

		if (NT_SUCCESS(ntStatus) && ProcessWow64Info != NULL)
			Ret = TRUE;

		ZwClose(hProcess);
	}	// if (hProcess)

	return(Ret);
}


static	HANDLE	OpenProcessById(HANDLE ProcessId, ACCESS_MASK AccessMask)
{
	HANDLE		hProcess;
	CLIENT_ID	ClientId = { 0 };
	OBJECT_ATTRIBUTES	oa = { 0 };

	ASSERT(KeGetCurrentIrql() == PASSIVE_LEVEL);

	ClientId.UniqueProcess = ProcessId;
	InitializeObjectAttributes(&oa, NULL, OBJ_CASE_INSENSITIVE | OBJ_KERNEL_HANDLE, 0, NULL);

	if (!(NT_SUCCESS(ZwOpenProcess(&hProcess, AccessMask, &oa, &ClientId))))
		hProcess = NULL;

	return(hProcess);
}
